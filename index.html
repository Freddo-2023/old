<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>City inspector - Endless Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #050508; font-family: 'Segoe UI', sans-serif; }
        #info-panel { position: absolute; top: 20px; right: 20px; width: 280px; background: rgba(0,0,0,0.85); color: white; padding: 20px; border-radius: 10px; border: 1px solid #444; display: none; backdrop-filter: blur(5px); z-index: 10; }
        #ui-top { position: absolute; top: 20px; left: 20px; color: white; pointer-events: none; z-index: 10; }
        .btn { pointer-events: auto; background: #fec309; border: none; padding: 10px; cursor: pointer; font-weight: bold; border-radius: 5px; margin-top: 10px; }
        h2 { margin-top: 0; color: #fec309; }
    </style>
</head>
<body>

    <div id="ui-top">
        <h1>City inspect v3 (Infinite)</h1>
        <p>Use Mouse to pan/zoom. Have fun exploring!</p>
        <button class="btn" onclick="toggleMusic()">ðŸŽµ Toggle Jazz Radio</button>
    </div>

    <div id="info-panel">
        <h2 id="b-name">Building Name</h2>
        <p><strong>Year:</strong> <span id="b-year"></span></p>
        <p><strong>Type:</strong> <span id="b-type"></span></p>
        <p id="b-desc"></p>
        <button class="btn" style="background:#444; color:white" onclick="document.getElementById('info-panel').style.display='none'">Close</button>
    </div>

    <audio id="JazzAudio" loop>
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-17.mp3" type="audio/mpeg">
    </audio>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.132.2';
        import { MapControls } from 'https://cdn.skypack.dev/three@0.132.2/examples/jsm/controls/OrbitControls.js';

        // --- DATA ---
        const buildingData = [
            { name: "Empire Heights", year: "1931", type: "Art Deco Skyscraper", desc: "A limestone masterpiece defining the midtown skyline." },
            { name: "Greenwich Flats", year: "1895", type: "Residential Brownstone", desc: "Classic walk-up apartments with original brickwork." },
            { name: "Lexington Plaza", year: "2015", type: "Glass Commercial", desc: "Modern tech hub with floor-to-ceiling reinforced glass." },
            { name: "The Manhattanite", year: "1950", type: "Mid-Century Apartment", desc: "Post-war housing known for high ceilings and terrace views." }
            { name: "Clocks Square", year: "1924", type: "A city square with stalls and markets", desc: "Was made for shops in the late 1920's." }
        ]; ];

        // --- CONSTANTS ---
        const CHUNK_SIZE = 200; // Size of one "block" of the city
        const SPAWN_RADIUS = 2;  // How many chunks around the camera to keep loaded
        const GRID_SPACING = 25; // Space between buildings

        // --- SCENE SETUP ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x050508, 0.002);
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 2000);
        camera.position.set(150, 150, 150);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        // MapControls is better for "scrolling" around a flat plane
        const controls = new MapControls(camera, renderer.domElement);
        controls.enableDamping = true;

        const sun = new THREE.DirectionalLight(0xffffff, 0.8);
        sun.position.set(100, 200, 100);
        scene.add(sun);
        scene.add(new THREE.AmbientLight(0x404050, 0.7));

        // --- TEXTURES ---
        function createCityTexture(isModern) {
            const canvas = document.createElement('canvas');
            canvas.width = 128; canvas.height = 256;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = isModern ? '#1a1a1a' : '#4a2525'; 
            ctx.fillRect(0,0,128,256);
            for(let y=10; y<250; y+=15) {
                for(let x=10; x<120; x+=12) {
                    ctx.fillStyle = Math.random() > 0.4 ? '#fff8cc' : '#111';
                    ctx.fillRect(x, y, 6, 8);
                }
            }
            return new THREE.CanvasTexture(canvas);
        }
        const modernTex = createCityTexture(true);
        const classicTex = createCityTexture(false);

        // --- INFINITE GENERATION LOGIC ---
        const chunks = new Map(); // Store chunks: "x,z" => THREE.Group
        const buildingsForRaycast = [];

        // Pseudo-random function to make buildings consistent based on coordinates
        function seededRandom(x, z) {
            const seed = Math.sin(x * 12.9898 + z * 78.233) * 43758.5453;
            return seed - Math.floor(seed);
        }

        function createChunk(cx, cz) {
            const chunkGroup = new THREE.Group();
            
            for (let x = 0; x < CHUNK_SIZE; x += GRID_SPACING) {
                for (let z = 0; z < CHUNK_SIZE; z += GRID_SPACING) {
                    const worldX = cx * CHUNK_SIZE + x;
                    const worldZ = cz * CHUNK_SIZE + z;
                    
                    const rand = seededRandom(worldX, worldZ);
                    const isTall = rand > 0.7;
                    const h = isTall ? 60 + (rand * 80) : 15 + (rand * 20);
                    
                    const geo = new THREE.BoxGeometry(15, h, 15);
                    const mat = new THREE.MeshPhongMaterial({ 
                        color: isTall ? 0x888899 : 0xaa8888, 
                        map: isTall ? modernTex : classicTex 
                    });

                    const b = new THREE.Mesh(geo, mat);
                    b.position.set(worldX, h/2, worldZ);
                    
                    // Assign random data from list based on seed
                    const dataIndex = Math.floor(rand * buildingData.length);
                    b.userData = buildingData[dataIndex];
                    
                    chunkGroup.add(b);
                    buildingsForRaycast.push(b);
                }
            }
            
            scene.add(chunkGroup);
            return chunkGroup;
        }

        function updateChunks() {
            const camX = Math.floor(camera.position.x / CHUNK_SIZE);
            const camZ = Math.floor(camera.position.z / CHUNK_SIZE);

            // Create new chunks
            for (let x = camX - SPAWN_RADIUS; x <= camX + SPAWN_RADIUS; x++) {
                for (let z = camZ - SPAWN_RADIUS; z <= camZ + SPAWN_RADIUS; z++) {
                    const key = `${x},${z}`;
                    if (!chunks.has(key)) {
                        chunks.set(key, createChunk(x, z));
                    }
                }
            }

            // Optional: Remove far away chunks to save memory
            for (let [key, group] of chunks) {
                const [cx, cz] = key.split(',').map(Number);
                if (Math.abs(cx - camX) > SPAWN_RADIUS + 1 || Math.abs(cz - camZ) > SPAWN_RADIUS + 1) {
                    scene.remove(group);
                    // Remove children from raycast list
                    group.children.forEach(child => {
                        const idx = buildingsForRaycast.indexOf(child);
                        if (idx > -1) buildingsForRaycast.splice(idx, 1);
                    });
                    chunks.delete(key);
                }
            }
        }

        // --- INTERACTION ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        window.addEventListener('click', (event) => {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(buildingsForRaycast);

            if (intersects.length > 0) {
                const data = intersects[0].object.userData;
                document.getElementById('info-panel').style.display = 'block';
                document.getElementById('b-name').innerText = data.name;
                document.getElementById('b-year').innerText = data.year;
                document.getElementById('b-type').innerText = data.type;
                document.getElementById('b-desc').innerText = data.desc;
            }
        });

        // --- ANIMATION ---
        function animate() {
            requestAnimationFrame(animate);
            updateChunks();
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        window.toggleMusic = function() {
            const music = document.getElementById('jazzAudio');
            if (music.paused) music.play();
            else music.pause();
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
